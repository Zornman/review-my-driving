<div class="page ao-page">
  <header class="ao-header">
    <div class="ao-header__text">
      <h3 class="ao-title">Account</h3>
      <p class="ao-subtitle" *ngIf="user?.metadata?.lastSignInTime">Last login: {{ user?.metadata?.lastSignInTime }}</p>
    </div>
  </header>

  <div class="ao-mobile-nav" *ngIf="tabLabels?.length">
    <mat-form-field appearance="outline" class="ao-mobile-nav__field">
      <mat-label>Navigate</mat-label>
      <mat-select [value]="selectedTabIndex" (selectionChange)="selectedTabIndex = $event.value">
        <mat-option *ngFor="let label of tabLabels; let i = index" [value]="i">{{ label }}</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <mat-tab-group
    class="ao-tabs"
    mat-stretch-tabs="false"
    mat-align-tabs="center"
    [selectedIndex]="selectedTabIndex"
    (selectedIndexChange)="selectedTabIndex = $event"
    (selectedTabChange)="onTabChange($event)"
  >
    <mat-tab [label]="isBusinessUser ? 'Overview' : 'Submissions'">
        <div class="ao-tab">
          <mat-card appearance="outlined" class="card ao-card">
            <mat-card-content>
              <div class="ao-section-header">
                <div>
                  <h3 class="ao-section-title">{{ isBusinessUser ? 'Overview' : 'Submissions' }}</h3>
                  <p class="ao-section-subtitle">Review recent activity and drill into details.</p>
                </div>
              </div>

              <div class="ao-stats">
                <div class="ao-stat">
                  <div class="ao-stat__value">
                    <ng-container *ngIf="todaysSubmissions !== undefined && todaysSubmissions !== null; else statLoading">{{ todaysSubmissions }}</ng-container>
                  </div>
                  <div class="ao-stat__label">Today ({{ todaysDate }})</div>
                </div>
                <div class="ao-stat">
                  <div class="ao-stat__value">
                    <ng-container *ngIf="lastWeekSubmissions !== undefined && lastWeekSubmissions !== null; else statLoading">{{ lastWeekSubmissions }}</ng-container>
                  </div>
                  <div class="ao-stat__label">Last 7 days</div>
                </div>
                <div class="ao-stat">
                  <div class="ao-stat__value">
                    <ng-container *ngIf="lastMonthSubmissions !== undefined && lastMonthSubmissions !== null; else statLoading">{{ lastMonthSubmissions }}</ng-container>
                  </div>
                  <div class="ao-stat__label">Last 30 days</div>
                </div>
                <div class="ao-stat">
                  <div class="ao-stat__value">
                    <ng-container *ngIf="totalSubmissions !== undefined && totalSubmissions !== null; else statLoading">{{ totalSubmissions }}</ng-container>
                  </div>
                  <div class="ao-stat__label">Total submissions</div>
                </div>
              </div>

              <div class="ao-separator"></div>

              <mat-tab-group
                *ngIf="showSubmissionScopeTabs"
                class="ao-tabs"
                mat-stretch-tabs="false"
                mat-align-tabs="center"
                [selectedIndex]="submissionScope === 'personal' ? 0 : 1"
                (selectedTabChange)="onSubmissionScopeTabChange($event)"
              >
                <mat-tab label="Personal"></mat-tab>
                <mat-tab label="Business"></mat-tab>
              </mat-tab-group>

              <div class="ao-table-wrap">
                <mat-table [dataSource]="submissionsDataSource" multiTemplateDataRows class="ao-table mat-elevation-z0">
                        <!-- Define columns -->
                        <ng-container matColumnDef="name">
                            <mat-header-cell *matHeaderCellDef> Name </mat-header-cell>
                            <mat-cell *matCellDef="let element">
                              <div class="ao-cell-stack">
                                <div>{{ element.firstName + ' ' + element.lastName + '.' }}</div>
                                <div
                                  *ngIf="submissionScope === 'business' && getBusinessTruckLabel(element) as truckLabel"
                                  class="ao-cell-subtext">
                                  Truck: {{ truckLabel }}
                                </div>
                              </div>
                            </mat-cell>
                        </ng-container>
                        
                        <ng-container matColumnDef="dateSubmitted">
                            <mat-header-cell *matHeaderCellDef> Date </mat-header-cell>
                          <mat-cell *matCellDef="let element"> {{ parseDate(element.dateSubmitted) | date }} </mat-cell>
                        </ng-container>
                        
                        <ng-container matColumnDef="reasonForContacting">
                            <mat-header-cell *matHeaderCellDef> Reason </mat-header-cell>
                          <mat-cell *matCellDef="let element"> {{ element.reasonForContacting ? element.reasonForContacting.replaceAll('_', ' ') : '—' }} </mat-cell>
                        </ng-container>
                        
                        <!-- Expand/Collapse Column -->
                        <ng-container matColumnDef="expand">
                            <mat-header-cell *matHeaderCellDef></mat-header-cell>
                            <mat-cell *matCellDef="let element">
                          <button mat-icon-button class="ao-expand-btn">
                                <mat-icon>{{ expandedElement === element ? 'expand_less' : 'expand_more' }}</mat-icon>
                            </button>
                            </mat-cell>
                        </ng-container>
        
                        <ng-container matColumnDef="expandedDetail">
                            <mat-cell
                              *matCellDef="let element"
                              class="ao-expanded-cell"
                              [attr.colspan]="submissionsColumnsToDisplay.length"
                              [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
                            <div class="ao-expanded">
                              <ng-container *ngIf="submissionScope === 'business'">
                                <div class="ao-expanded__label">Truck</div>
                                <div class="ao-expanded__value">{{ getBusinessTruckDisplay(element) }}</div>

                                <div class="ao-expanded__label">Assigned Driver</div>
                                <div class="ao-expanded__value">{{ getBusinessDriverDisplay(element) }}</div>

                                <div class="ao-expanded__label">Asset ID</div>
                                <div class="ao-expanded__value">{{ element.assetId || '—' }}</div>
                              </ng-container>
                              <div class="ao-expanded__label">Comment</div>
                              <div class="ao-expanded__value">{{ element.description }}</div>
                            </div>
                            </mat-cell>
                        </ng-container>
                        
                        <!-- Header Row -->
                        <mat-header-row *matHeaderRowDef="submissionsColumnsToDisplay" class="ao-header-row"></mat-header-row>
                        
                        <!-- Data Row -->
                        <mat-row 
                          class="ao-row"
                          [class.is-expanded]="expandedElement === element"
                          *matRowDef="let element; columns: submissionsColumnsToDisplay;" 
                          (click)="toggleRow(element, $event)">
                        </mat-row>
                        
                        <!-- Expanded Detail Row -->
                        <mat-row *matRowDef="let element; columns: ['expandedDetail']" class="ao-detail-row" [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'"></mat-row>

                        <!-- Row shown when there is no matching data that will be provided to the wrapper table. -->
                        <tr class="mat-row" *matNoDataRow>
                          <td class="mat-cell" colspan="4">{{ noSubmissionsMessage }}</td>
                        </tr>
                </mat-table>
              </div>

              <div class="ao-paginator">
                <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of submissions"></mat-paginator>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
    </mat-tab>
    <mat-tab label="Trucks & Drivers" *ngIf="isBusinessUser">
      <app-truck-and-driver-management></app-truck-and-driver-management>
    </mat-tab>
    <mat-tab label="QR Codes" *ngIf="isBusinessUser">
      <app-manage-qr-codes></app-manage-qr-codes>
    </mat-tab>
    <mat-tab label="Daily Report Summary" *ngIf="isBusinessUser">
      <app-daily-reports-summary *ngIf="businessUserInfo" [businessUserInfo]="businessUserInfo"></app-daily-reports-summary>
    </mat-tab>
    <mat-tab label="Business Settings" *ngIf="isBusinessUser">
      <app-business-functions *ngIf="businessUserInfo" [businessUserInfo]="businessUserInfo"></app-business-functions>
    </mat-tab>
    <mat-tab label="Account Overview" *ngIf="!isBusinessUser">
        <div class="ao-tab">
          <mat-card appearance="outlined" class="card ao-card">
            <mat-card-content>
              <div class="ao-section-header">
                <div>
                  <h3 class="ao-section-title">Account Overview</h3>
                  <p class="ao-section-subtitle">This information cannot be modified at this time.</p>
                </div>
              </div>

              <form [formGroup]="accOverviewForm" class="ao-form ao-form--readonly">
                  <mat-form-field appearance="outline" class="full-width">
                      <mat-label>User ID</mat-label>
                      <input matInput formControlName="userID" name="userID">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Display Name</mat-label>
                      <input matInput formControlName="name" name="name">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                      <mat-label>E-Mail</mat-label>
                      <input matInput formControlName="email" name="email">
                  </mat-form-field>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
    </mat-tab>
    <mat-tab label="Shipping Information" style="overflow-y: hidden;">
      <app-shipping-information></app-shipping-information>
    </mat-tab>
    <mat-tab label="Order History" *ngIf="!isBusinessUser">
            <div class="ao-tab">
              <mat-card appearance="outlined" class="card ao-card">
              <mat-card-content>
                <div class="ao-section-header">
                <div>
                  <h3 class="ao-section-title">Order History</h3>
                  <p class="ao-section-subtitle">Track previous purchases and order status.</p>
                </div>
                </div>

                <div class="ao-table-wrap">
                  <table mat-table matSort [dataSource]="ordersDataSource" multiTemplateDataRows class="ao-table mat-elevation-z0">
                        <!-- Define columns -->
                        <ng-container matColumnDef="orderNum">
                            <mat-header-cell *matHeaderCellDef> Order # </mat-header-cell>
                            <mat-cell *matCellDef="let element"> {{ element.orderID }} </mat-cell>
                        </ng-container>

                        <ng-container matColumnDef="status">
                          <mat-header-cell *matHeaderCellDef> Status </mat-header-cell>
                          <mat-cell *matCellDef="let element"> {{ element.status }} </mat-cell>
                      </ng-container>
                        
                        <ng-container matColumnDef="dateOrdered">
                            <mat-header-cell *matHeaderCellDef> Date Ordered </mat-header-cell>
                            <mat-cell *matCellDef="let element"> {{ element.dateOrdered }} </mat-cell>
                        </ng-container>
                        
                        <!-- Header Row -->
                        <mat-header-row *matHeaderRowDef="ordersColumnsToDisplay" class="ao-header-row"></mat-header-row>
                        
                        <!-- Data Row -->
                        <mat-row 
                          class="ao-row"
                            *matRowDef="let element; columns: ordersColumnsToDisplay;" 
                            (click)="toggleRow(element, $event)">
                        </mat-row>
                        
                        <!-- Row shown when there is no matching data that will be provided to the wrapper table. -->
                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" colspan="4">
                                <p>No orders yet, head to the shop and place an order to get started!</p>
                            </td>
                        </tr>
                    </table>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
    </mat-tab>
</mat-tab-group>

<ng-template #statLoading>
  <span class="ao-stat__loading">…</span>
</ng-template>

</div>

<ng-template #loading>
  <div class="spinner">
      <img src="assets/images/spinner.gif" alt="Loading..." height="100" width="100" />
  </div>
</ng-template>