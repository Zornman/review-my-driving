<div class="page drs-page">
	<header class="drs-header">
		<div class="drs-header__text">
			<h3 class="drs-title">Daily Report Summary</h3>
			<p class="drs-subtitle">Track completion and review submitted details.</p>
		</div>
	</header>

	<mat-card appearance="outlined" class="card drs-card">
		<mat-card-content>
			<form [formGroup]="form" class="filters drs-filters" (ngSubmit)="refresh()">
				<mat-form-field appearance="outline" class="filter drs-filter">
					<mat-label>Start date</mat-label>
					<input matInput [matDatepicker]="startPicker" formControlName="startDate" />
					<mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
					<mat-datepicker #startPicker></mat-datepicker>
				</mat-form-field>

				<mat-form-field appearance="outline" class="filter drs-filter">
					<mat-label>End date</mat-label>
					<input matInput [matDatepicker]="endPicker" formControlName="endDate" />
					<mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
					<mat-datepicker #endPicker></mat-datepicker>
				</mat-form-field>

				<div class="drs-sort" aria-label="Sort order">
					<div class="drs-sort-label">Sort</div>
					<mat-button-toggle-group formControlName="sortOrder" [disabled]="isLoading" aria-label="Sort order">
						<mat-button-toggle value="desc" class="sort-button">Newest</mat-button-toggle>
						<mat-button-toggle value="asc" class="sort-button">Oldest</mat-button-toggle>
					</mat-button-toggle-group>
				</div>

				<button mat-flat-button color="primary" type="submit" [disabled]="isLoading || form.invalid">
					<mat-icon>refresh</mat-icon>
					Refresh
				</button>
			</form>

			<div class="status-row drs-status-row" *ngIf="isLoading">
				<mat-progress-spinner diameter="22" mode="indeterminate"></mat-progress-spinner>
				<span>Loading summaries…</span>
			</div>

			<div class="error drs-error" *ngIf="loadError">{{ loadError }}</div>

			<div class="empty drs-empty" *ngIf="!isLoading && !loadError && days.length === 0">
				No daily reports found for this date range.
			</div>

			<mat-accordion class="days drs-days" *ngIf="!isLoading && !loadError && days.length">
				<mat-expansion-panel
					*ngFor="let day of days; trackBy: trackByDay"
					[expanded]="expandedDay === day.reportDateLocal"
					(opened)="expandedDay = day.reportDateLocal">

					<mat-expansion-panel-header>
						<mat-panel-title>
							<span class="day-title drs-day-title">{{ day.reportDateLocal }}</span>
						</mat-panel-title>
						<mat-panel-description>
							<span class="day-stats drs-day-stats">
								{{ day.totals.submitted + day.totals.waived }}/{{ day.totals.expected }} complete
								· {{ day.totals.pending }} pending
								· {{ day.totals.missing }} missing
							</span>
						</mat-panel-description>
					</mat-expansion-panel-header>

					<div class="day-progress drs-day-progress">
						<mat-progress-bar mode="determinate" [value]="completionPercent(day)"></mat-progress-bar>
						<div class="day-progress-label drs-day-progress-label">{{ completionPercent(day) }}%</div>
					</div>

					<mat-accordion class="drivers drs-drivers" multi>
						<mat-expansion-panel *ngFor="let group of groupByDriver(day.rows); trackBy: trackByDriverGroup">
							<mat-expansion-panel-header>
								<mat-panel-title>
									<span class="driver-name drs-driver-name">{{ group.driverName }}</span>
									<span class="driver-email drs-driver-email" *ngIf="group.driverEmail">({{ group.driverEmail }})</span>
								</mat-panel-title>
								<mat-panel-description>
									<span class="driver-count drs-driver-count">{{ group.rows.length }} truck(s)</span>
								</mat-panel-description>
							</mat-expansion-panel-header>

							<div class="truck drs-truck" *ngFor="let row of group.rows; trackBy: trackByTruckRow">
								<div class="truck-header drs-truck-header">
									<div class="truck-left drs-truck-left">
										<div class="truck-title drs-truck-title">{{ row.truckLabel || 'Truck' }}</div>
										<div class="truck-meta drs-truck-meta" *ngIf="row.token?.sentAt">Email sent: {{ row.token?.sentAt | date:'short' }}</div>
									</div>

									<mat-chip-set aria-label="Report status">
										<mat-chip class="status-chip drs-status-chip" [ngClass]="'status-' + row.status">
											<mat-icon class="status-icon drs-status-icon">{{ statusIcon(row.status) }}</mat-icon>
											{{ statusLabel(row.status) }}
										</mat-chip>
									</mat-chip-set>
								</div>

								<div class="report drs-report" *ngIf="row.report">
									<div class="report-grid drs-report-grid">
										<div><strong>Submitted:</strong> {{ row.report.submittedAt | date:'short' }}</div>
										<div><strong>Odometer:</strong> {{ row.report.odometer ?? '—' }}</div>
										<div><strong>Issues:</strong> {{ row.report.issues || '—' }}</div>
										<div><strong>Issues Summary:</strong> {{ row.report.issuesSummary || '—' }}</div>
									</div>

									<div class="photos drs-photos" *ngIf="row.report.photos?.length">
										<div class="photos-title drs-photos-title">Photos</div>
										<div class="photos-grid drs-photos-grid">
											<div class="photo drs-photo" *ngFor="let p of row.report.photos">
												<div class="photo-slot drs-photo-slot">{{ p.slot }}</div>
												<img *ngIf="photoUrl(p)" [src]="photoUrl(p)" [alt]="p.slot" />
												<div class="photo-missing drs-photo-missing" *ngIf="!photoUrl(p)">
													<span *ngIf="p.storagePath">Stored: {{ p.storagePath }}</span>
													<span *ngIf="!p.storagePath">No URL available</span>
												</div>
											</div>
										</div>
									</div>

									<div class="photos drs-photos" *ngIf="!row.report.photos?.length">
										<div class="photos-title drs-photos-title">Photos</div>
										<div class="photo-missing drs-photo-missing">No photos recorded on this report.</div>
									</div>
								</div>

								<div class="report drs-report" *ngIf="!row.report">
									<div class="report-empty drs-report-empty">
										<span *ngIf="row.status === 'pending'">Waiting for submission.</span>
										<span *ngIf="row.status === 'missing'">No active token/report found.</span>
									</div>
								</div>
							</div>
						</mat-expansion-panel>
					</mat-accordion>
				</mat-expansion-panel>
			</mat-accordion>
		</mat-card-content>
	</mat-card>
</div>
